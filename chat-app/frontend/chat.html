<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Chat</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="icon.png">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .chat-header {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-header h2 {
            margin: 0;
            font-size: 1.2em;
        }
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .message {
            max-width: 70%;
            padding: 10px;
            border-radius: 10px;
            position: relative;
        }
        .message.sent {
            background-color: #007bff;
            color: white;
            align-self: flex-end;
        }
        .message.received {
            background-color: #e9ecef;
            color: black;
            align-self: flex-start;
        }
        .message .timestamp {
            font-size: 0.8em;
            color: #888;
            margin-top: 5px;
        }
        .chat-input {
            display: flex;
            padding: 10px;
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 20px;
            margin-right: 10px;
            outline: none;
        }
        .chat-input button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }
        .chat-input button:hover {
            background-color: #0056b3;
        }
        .call-buttons {
            display: flex;
            gap: 10px;
        }
        .call-buttons button {
            padding: 8px 16px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .call-buttons button:hover {
            background-color: #218838;
        }
        #video-container {
            display: none;
            padding: 20px;
            background-color: #000;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            justify-content: space-around;
            align-items: center;
        }
        #video-container video {
            width: 45%;
            border: 2px solid #fff;
            border-radius: 5px;
        }
        #end-call {
            position: absolute;
            bottom: 20px;
            padding: 10px 20px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #end-call:hover {
            background-color: #c82333;
        }
        #incoming-call {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            text-align: center;
        }
        #incoming-call button {
            margin: 10px;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #incoming-call .accept {
            background-color: #28a745;
            color: white;
        }
        #incoming-call .reject {
            background-color: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h2 id="chat-partner">Chat</h2>
            <div class="call-buttons">
                <button onclick="initiateCall('video')">Video Call</button>
                <button onclick="initiateCall('audio')">Audio Call</button>
            </div>
        </div>
        <div class="chat-messages" id="messages"></div>
        <div class="chat-input">
            <input type="text" id="message-input" placeholder="Type a message..." onkeypress="if(event.key === 'Enter') sendMessage(document.getElementById('message-input').value)">
            <button onclick="sendMessage(document.getElementById('message-input').value)">Send</button>
        </div>
    </div>

    <!-- Video Call Interface -->
    <div id="video-container">
        <video id="local-video" autoplay playsinline muted></video>
        <video id="remote-video" autoplay playsinline></video>
        <button id="end-call" onclick="endCall()">End Call</button>
    </div>

    <!-- Incoming Call Prompt -->
    <div id="incoming-call">
        <p id="caller-info"></p>
        <button class="accept" onclick="acceptCall()">Accept</button>
        <button class="reject" onclick="rejectCall()">Reject</button>
    </div>

    <script>
        let username = localStorage.getItem('username');
        let chatPartner = localStorage.getItem('chatPartner');
        let ws;
        let peerConnection;
        let localStream;
        let remoteStream;
        let callType;
        let currentCallInitiator;

        // Redirect to login if username is not set
        if (!username || username === "null") {
            alert("Please log in to access the chat.");
            window.location.href = "login.html";
            throw new Error("Username not found");
        }

        // Set chat partner in header
        if (chatPartner) {
            document.getElementById('chat-partner').textContent = `Chat with ${chatPartner}`;
        }

        // Establish WebSocket connection
        function connectWebSocket() {
            ws = new WebSocket(`wss://chat-backend-gxh8.onrender.com/ws?username=${encodeURIComponent(username)}`);

            ws.onopen = () => {
                console.log("WebSocket connection established");
                loadMessages();
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                console.log("Received message:", msg);
                if (msg.Type === "text" || msg.Type === "file") {
                    displayMessage(msg);
                } else if (msg.Type === "call_signal") {
                    handleCallSignal(msg);
                }
            };

            ws.onerror = (event) => {
                console.error("WebSocket error:", event);
            };

            ws.onclose = () => {
                console.log("WebSocket connection closed");
                setTimeout(connectWebSocket, 3000);
            };
        }

        // Load previous messages from Supabase
        async function loadMessages() {
            const chatId = `${username}:${chatPartner}`;
            const response = await fetch(`https://chat-backend-gxh8.onrender.com/messages?chat_id=${chatId}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            });
            const messages = await response.json();
            messages.forEach(displayMessage);
        }

        // Send a message
        function sendMessage(content, type = "text") {
            if (!content.trim()) return;
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                console.error("WebSocket is not connected");
                return;
            }
            const message = {
                Type: type,
                Sender: username,
                Receiver: chatPartner,
                Content: content,
                Timestamp: new Date().toISOString(),
                Status: "sent"
            };
            ws.send(JSON.stringify(message));
            displayMessage(message);
            document.getElementById('message-input').value = '';
        }

        // Display a message in the UI
        function displayMessage(msg) {
            const messagesDiv = document.getElementById("messages");
            const messageElement = document.createElement("div");
            messageElement.className = msg.Sender === username ? "message sent" : "message received";
            messageElement.textContent = `${msg.Sender}: ${msg.Content}`;
            const timestamp = document.createElement("div");
            timestamp.className = "timestamp";
            timestamp.textContent = new Date(msg.Timestamp).toLocaleTimeString();
            messageElement.appendChild(timestamp);
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Register push notifications
        async function registerPushNotifications() {
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                try {
                    const registration = await navigator.serviceWorker.register('/service-worker.js');
                    console.log('Service Worker registered:', registration);

                    const subscription = await registration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: 'BJPmu7lxFqlwyEnBJPfSYdfpqDi_A4EoOmt4fSYqvmjY8IIo44D6vbKQkZGTfx9rcCfxZ4ykHHSacmlo-GkhBeY' // Replace with your VAPID public key
                    });

                    await fetch('https://chat-backend-gxh8.onrender.com/register-push', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({
                            username: localStorage.getItem('username'),
                            token: JSON.stringify(subscription)
                        })
                    });
                    console.log('Push subscription registered');
                } catch (error) {
                    console.error('Failed to register push notifications:', error);
                }
            }
        }

        // WebRTC setup
        const servers = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }
            ]
        };

        async function initiateCall(type) {
            callType = type;
            peerConnection = new RTCPeerConnection(servers);

            // Set up local stream
            localStream = await navigator.mediaDevices.getUserMedia({
                video: type === 'video',
                audio: true
            });
            document.getElementById('local-video').srcObject = localStream;
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            // Set up remote stream
            remoteStream = new MediaStream();
            document.getElementById('remote-video').srcObject = remoteStream;
            peerConnection.ontrack = (event) => {
                event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));
            };

            // Handle ICE candidates
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send(JSON.stringify({
                        Type: "call_signal",
                        Sender: username,
                        Receiver: chatPartner,
                        Signal: {
                            Type: "ice-candidate",
                            Candidate: event.candidate
                        }
                    }));
                }
            };

            // Create offer
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            ws.send(JSON.stringify({
                Type: "call_signal",
                Sender: username,
                Receiver: chatPartner,
                Signal: {
                    Type: "call-initiate",
                    Offer: offer,
                    CallType: type
                }
            }));

            document.getElementById('video-container').style.display = 'flex';
        }

        async function handleCallSignal(msg) {
            if (!peerConnection && msg.Signal.Type !== "call-initiate") return;

            switch (msg.Signal.Type) {
                case "call-initiate":
                    currentCallInitiator = msg.Sender;
                    callType = msg.Signal.CallType;
                    document.getElementById('caller-info').textContent = `Incoming ${callType} call from ${msg.Sender}`;
                    document.getElementById('incoming-call').style.display = 'block';
                    break;

                case "call-accept":
                    if (msg.Sender === chatPartner) {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(msg.Signal.Answer));
                    }
                    break;

                case "call-reject":
                    endCall();
                    break;

                case "offer":
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(msg.Signal.Offer));
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    ws.send(JSON.stringify({
                        Type: "call_signal",
                        Sender: username,
                        Receiver: chatPartner,
                        Signal: {
                            Type: "answer",
                            Answer: answer
                        }
                    }));
                    break;

                case "answer":
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(msg.Signal.Answer));
                    break;

                case "ice-candidate":
                    await peerConnection.addIceCandidate(new RTCIceCandidate(msg.Signal.Candidate));
                    break;
            }
        }

        async function acceptCall() {
            document.getElementById('incoming-call').style.display = 'none';
            peerConnection = new RTCPeerConnection(servers);

            // Set up local stream
            localStream = await navigator.mediaDevices.getUserMedia({
                video: callType === 'video',
                audio: true
            });
            document.getElementById('local-video').srcObject = localStream;
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            // Set up remote stream
            remoteStream = new MediaStream();
            document.getElementById('remote-video').srcObject = remoteStream;
            peerConnection.ontrack = (event) => {
                event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));
            };

            // Handle ICE candidates
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send(JSON.stringify({
                        Type: "call_signal",
                        Sender: username,
                        Receiver: chatPartner,
                        Signal: {
                            Type: "ice-candidate",
                            Candidate: event.candidate
                        }
                    }));
                }
            };

            // Create answer
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            ws.send(JSON.stringify({
                Type: "call_signal",
                Sender: username,
                Receiver: currentCallInitiator,
                Signal: {
                    Type: "call-accept",
                    Answer: offer,
                    CallStatus: "accepted"
                }
            }));

            document.getElementById('video-container').style.display = 'flex';
        }

        function rejectCall() {
            document.getElementById('incoming-call').style.display = 'none';
            ws.send(JSON.stringify({
                Type: "call_signal",
                Sender: username,
                Receiver: currentCallInitiator,
                Signal: {
                    Type: "call-reject",
                    CallStatus: "rejected"
                }
            }));
        }

        function endCall() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
                remoteStream = null;
            }
            document.getElementById('video-container').style.display = 'none';
            document.getElementById('local-video').srcObject = null;
            document.getElementById('remote-video').srcObject = null;
        }

        // Initialize on page load
        document.addEventListener("DOMContentLoaded", () => {
            connectWebSocket();
            registerPushNotifications();
        });
    </script>
</body>
</html>
