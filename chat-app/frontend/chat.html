<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #chat-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        #messages {
            border: 1px solid #ccc;
            padding: 10px;
            height: 400px;
            overflow-y: scroll;
            margin-bottom: 20px;
        }
        #messages div {
            margin-bottom: 10px;
        }
        #call-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        #call-modal-content {
            background: white;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="chat-container">
        <h1 class="text-2xl font-bold mb-4">Chat App</h1>
        <div id="chat-selection" class="mb-4">
            <label for="chat-partner" class="block text-sm font-medium text-gray-700">Select Chat Partner:</label>
            <select id="chat-partner" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <option value="">-- Select a user --</option>
            </select>
            <button id="start-chat" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Start Chat</button>
        </div>
        <div id="chat-interface" class="hidden">
            <div id="messages"></div>
            <div class="flex mb-2">
                <input type="text" id="message-input" class="flex-grow border rounded-l px-4 py-2 focus:outline-none" placeholder="Type a message...">
                <button id="send-message" class="bg-blue-500 text-white px-4 py-2 rounded-r hover:bg-blue-600">Send</button>
            </div>
            <div class="flex space-x-2">
                <button id="attach-file" class="bg-gray-300 text-black px-4 py-2 rounded hover:bg-gray-400">ðŸ“Ž Attach File</button>
                <input type="file" id="file-input" class="hidden">
                <button id="start-video-call" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">ðŸ“¹ Video Call</button>
                <button id="start-audio-call" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">ðŸ“ž Audio Call</button>
            </div>
        </div>
    </div>

    <div id="call-modal">
        <div id="call-modal-content">
            <p id="call-message"></p>
            <video id="local-video" autoplay playsinline muted class="w-32 h-32"></video>
            <video id="remote-video" autoplay playsinline class="w-64 h-64"></video>
            <div class="mt-4">
                <button id="accept-call" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 mr-2">Accept</button>
                <button id="reject-call" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Reject</button>
                <button id="end-call" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 hidden">End Call</button>
            </div>
        </div>
    </div>

    <script>
        const chatPartnerSelect = document.getElementById('chat-partner');
        const startChatButton = document.getElementById('start-chat');
        const chatInterface = document.getElementById('chat-interface');
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendMessageButton = document.getElementById('send-message');
        const attachFileButton = document.getElementById('attach-file');
        const fileInput = document.getElementById('file-input');
        const startVideoCallButton = document.getElementById('start-video-call');
        const startAudioCallButton = document.getElementById('start-audio-call');
        const callModal = document.getElementById('call-modal');
        const callMessage = document.getElementById('call-message');
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');
        const acceptCallButton = document.getElementById('accept-call');
        const rejectCallButton = document.getElementById('reject-call');
        const endCallButton = document.getElementById('end-call');

        let ws;
        let peerConnection;
        let currentChatId = '';
        let currentReceiver = '';
        let token = '';
        let username = '';
        let localStream;
        let incomingCall = false;
        let callType = '';

        // Get token and username from localStorage
        token = localStorage.getItem('token');
        if (!token) {
            alert('Please log in first');
            window.location.href = 'login.html';
        }
        username = localStorage.getItem('username');

        // Fetch allowed chat partners
        async function fetchAllowedChats() {
            const response = await fetch('https://chat-backend-gxh8.onrender.com/allowed-chats', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            if (!response.ok) {
                throw new Error('Failed to fetch allowed chats');
            }
            const allowedUsers = await response.json();
            allowedUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                chatPartnerSelect.appendChild(option);
            });
        }

        // Initialize the page by fetching allowed chats
        fetchAllowedChats().catch(err => {
            console.error('Error fetching allowed chats:', err);
            alert('Failed to load chat partners. Please try again.');
        });

        startChatButton.addEventListener('click', () => {
            const receiver = chatPartnerSelect.value;
            if (!receiver) {
                alert('Please select a chat partner');
                return;
            }

            currentReceiver = receiver;
            currentChatId = `${username}:${receiver}`;
            chatInterface.classList.remove('hidden');
            document.getElementById('chat-selection').classList.add('hidden');
            messagesDiv.innerHTML = '';
            fetchMessages();
            connectWebSocket();
        });

        async function fetchMessages() {
            const response = await fetch(`https://chat-backend-gxh8.onrender.com/messages?chat_id=${currentChatId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const messages = await response.json();
            messages.forEach(displayMessage);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function displayMessage(message) {
            const div = document.createElement('div');
            div.className = message.sender === username ? 'text-right text-blue-600' : 'text-left text-green-600';
            
            if (message.type === 'text') {
                div.textContent = `${message.sender}: ${message.content}`;
            } else if (message.type === 'file') {
                if (message.file_type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = message.file_url;
                    img.className = 'max-w-xs my-2';
                    img.onerror = () => img.src = 'https://via.placeholder.com/150?text=Image+Not+Found';
                    div.textContent = `${message.sender}: `;
                    div.appendChild(img);
                } else {
                    const a = document.createElement('a');
                    a.href = message.file_url;
                    a.textContent = 'Download File';
                    a.className = 'text-blue-500 underline';
                    div.textContent = `${message.sender}: `;
                    div.appendChild(a);
                }
            }
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function connectWebSocket() {
            ws = new WebSocket(`wss://chat-backend-gxh8.onrender.com/ws?username=${username}&token=${token}`);
            ws.onopen = () => console.log('WebSocket connected');
            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                if (message.type === 'call_signal' && message.signal.type === 'call-initiate') {
                    incomingCall = true;
                    callType = message.signal.call_type;
                    callMessage.textContent = `Incoming ${callType} call from ${message.sender}`;
                    callModal.style.display = 'flex';
                    acceptCallButton.classList.remove('hidden');
                    rejectCallButton.classList.remove('hidden');
                    endCallButton.classList.add('hidden');
                } else {
                    displayMessage(message);
                }
            };
            ws.onclose = () => console.log('WebSocket disconnected');
        }

        sendMessageButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        function sendMessage() {
            const content = messageInput.value.trim();
            if (!content || !currentReceiver) return;
            const message = {
                type: 'text',
                sender: username,
                receiver: currentReceiver,
                content: content,
                timestamp: new Date().toISOString(),
                status: 'persistent'
            };
            ws.send(JSON.stringify(message));
            messageInput.value = '';
        }

        attachFileButton.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', async () => {
            const file = fileInput.files[0];
            if (!file || !currentReceiver) return;

            const formData = new FormData();
            formData.append('file', file);
            const response = await fetch('https://chat-backend-gxh8.onrender.com/upload', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            });
            const { file_url } = await response.json();
            const message = {
                type: 'file',
                sender: username,
                receiver: currentReceiver,
                file_url: file_url,
                file_type: file.type,
                timestamp: new Date().toISOString(),
                status: 'persistent'
            };
            ws.send(JSON.stringify(message));
            fileInput.value = '';
        });

        startVideoCallButton.addEventListener('click', () => initiateCall('video'));
        startAudioCallButton.addEventListener('click', () => initiateCall('audio'));

        async function initiateCall(type) {
            callType = type;
            callMessage.textContent = `Calling ${currentReceiver}... (${callType})`;
            callModal.style.display = 'flex';
            acceptCallButton.classList.add('hidden');
            rejectCallButton.classList.add('hidden');
            endCallButton.classList.remove('hidden');

            localStream = await navigator.mediaDevices.getUserMedia({ video: type === 'video', audio: true });
            localVideo.srcObject = localStream;

            peerConnection = new RTCPeerConnection();
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            peerConnection.ontrack = (event) => {
                remoteVideo.srcObject = event.streams[0];
            };

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send(JSON.stringify({
                        type: 'call_signal',
                        sender: username,
                        receiver: currentReceiver,
                        signal: { type: 'ice-candidate', candidate: event.candidate }
                    }));
                }
            };

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            ws.send(JSON.stringify({
                type: 'call_signal',
                sender: username,
                receiver: currentReceiver,
                signal: { type: 'call-initiate', offer: offer, call_type: callType }
            }));
        }

        acceptCallButton.addEventListener('click', async () => {
            incomingCall = false;
            callMessage.textContent = `In ${callType} call with ${currentReceiver}`;
            acceptCallButton.classList.add('hidden');
            rejectCallButton.classList.add('hidden');
            endCallButton.classList.remove('hidden');

            localStream = await navigator.mediaDevices.getUserMedia({ video: callType === 'video', audio: true });
            localVideo.srcObject = localStream;

            peerConnection = new RTCPeerConnection();
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            peerConnection.ontrack = (event) => {
                remoteVideo.srcObject = event.streams[0];
            };

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send(JSON.stringify({
                        type: 'call_signal',
                        sender: username,
                        receiver: currentReceiver,
                        signal: { type: 'ice-candidate', candidate: event.candidate }
                    }));
                }
            };

            const offer = JSON.parse(localStorage.getItem('pending-offer'));
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            ws.send(JSON.stringify({
                type: 'call_signal',
                sender: username,
                receiver: currentReceiver,
                signal: { type: 'call-accept', answer: answer, call_status: 'accepted' }
            }));
        });

        rejectCallButton.addEventListener('click', () => {
            incomingCall = false;
            callModal.style.display = 'none';
            ws.send(JSON.stringify({
                type: 'call_signal',
                sender: username,
                receiver: currentReceiver,
                signal: { type: 'call-reject', call_status: 'rejected' }
            }));
        });

        endCallButton.addEventListener('click', () => {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
            callModal.style.display = 'none';
        });

        // Request notification permission
        if ('Notification' in window) {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    navigator.serviceWorker.register('service-worker.js').then(registration => {
                        registration.pushManager.subscribe({
                            userVisibleOnly: true,
                            applicationServerKey: 'YOUR_PUBLIC_VAPID_KEY'
                        }).then(subscription => {
                            fetch('https://chat-backend-gxh8.onrender.com/register-push', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({
                                    username: username,
                                    token: subscription.toJSON()
                                })
                            });
                        });
                    });
                }
            });
        }
    </script>
</body>
</html>
