<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            background-color: #f0f2f5;
        }
        #sidebar {
            width: 300px;
            background-color: #fff;
            border-right: 1px solid #ddd;
            padding: 20px;
            overflow-y: auto;
        }
        #chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #fff;
        }
        #chat-header {
            padding: 20px;
            background-color: #0084ff;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        #chat-input {
            padding: 20px;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
        }
        #message-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            background-color: #0084ff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0066cc;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 10px;
            max-width: 70%;
        }
        .message.sent {
            background-color: #0084ff;
            color: white;
            margin-left: auto;
        }
        .message.received {
            background-color: #e9ecef;
            margin-right: auto;
        }
        #video-call {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        video {
            width: 45%;
            margin: 10px;
            border: 2px solid #fff;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <h2>Users</h2>
        <div id="user-list"></div>
    </div>
    <div id="chat-area">
        <div id="chat-header">
            <h2 id="chat-partner">Select a user to chat</h2>
            <div>
                <button onclick="initiateCall('video')">Video Call</button>
                <button onclick="initiateCall('audio')">Audio Call</button>
            </div>
        </div>
        <div id="chat-messages"></div>
        <div id="chat-input">
            <input type="text" id="message-input" placeholder="Type a message..." onkeypress="if(event.keyCode===13) sendMessage()">
            <input type="file" id="file-input" style="display: none;" onchange="uploadFile()">
            <button onclick="document.getElementById('file-input').click()">ðŸ“Ž</button>
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>
    <div id="video-call">
        <video id="local-video" autoplay playsinline muted></video>
        <video id="remote-video" autoplay playsinline></video>
        <button onclick="endCall()">End Call</button>
    </div>

    <script>
        let ws;
        let token = localStorage.getItem('token');
        let userID = localStorage.getItem('chat_id').split(':')[0];
        let currentChatPartner = null;
        let peerConnection;
        let localStream;
        let currentCallType;

        // WebSocket connection
        function connectWebSocket() {
            ws = new WebSocket(`wss://chat-backend-gxh8.onrender.com/ws?token=${token}`);
            ws.onopen = () => console.log('WebSocket connected');
            ws.onmessage = handleMessage;
            ws.onclose = () => setTimeout(connectWebSocket, 1000);
            ws.onerror = (err) => console.error('WebSocket error:', err);
        }

        // Fetch allowed chats and users
        async function loadUsers() {
            const response = await fetch('https://chat-backend-gxh8.onrender.com/allowed-chats', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const chats = await response.json();
            const userList = document.getElementById('user-list');
            userList.innerHTML = '';

            // Assuming an endpoint to fetch all users
            const usersResponse = await fetch('https://chat-backend-gxh8.onrender.com/users', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const users = await usersResponse.json();
            users.forEach(user => {
                if (user.user_id !== userID) {
                    const userDiv = document.createElement('div');
                    userDiv.textContent = user.username;
                    userDiv.style.padding = '10px';
                    userDiv.style.cursor = 'pointer';
                    userDiv.onclick = () => selectChatPartner(user.user_id, user.username);
                    userList.appendChild(userDiv);
                }
            });
        }

        // Select a chat partner
        function selectChatPartner(partnerID, username) {
            currentChatPartner = partnerID;
            document.getElementById('chat-partner').textContent = username;
            loadMessages();
        }

        // Load messages for the current chat
        async function loadMessages() {
            if (!currentChatPartner) return;
            const chatID = `${userID}:${currentChatPartner}`;
            const response = await fetch(`https://chat-backend-gxh8.onrender.com/messages?chat_id=${chatID}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const messages = await response.json();
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = '';
            messages.forEach(msg => displayMessage(msg));
        }

        // Display a message
        function displayMessage(msg) {
            const chatMessages = document.getElementById('chat-messages');
            const msgDiv = document.createElement('div');
            msgDiv.className = msg.sender === userID ? 'message sent' : 'message received';
            if (msg.type === 'text') {
                msgDiv.textContent = msg.content;
            } else if (msg.type === 'file') {
                const link = document.createElement('a');
                link.href = `/file/${msg.file_url}`;
                link.textContent = 'Download File';
                link.target = '_blank';
                msgDiv.appendChild(link);
            }
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Send a message
        function sendMessage() {
            if (!currentChatPartner) return;
            const input = document.getElementById('message-input');
            const content = input.value.trim();
            if (content === '') return;

            const message = {
                type: 'text',
                sender: userID,
                receiver: currentChatPartner,
                content: content,
                timestamp: new Date().toISOString()
            };
            ws.send(JSON.stringify(message));
            input.value = '';
        }

        // Upload a file
        async function uploadFile() {
            if (!currentChatPartner) return;
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);
            const response = await fetch('https://chat-backend-gxh8.onrender.com/upload', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });
            const result = await response.json();

            const message = {
                type: 'file',
                sender: userID,
                receiver: currentChatPartner,
                file_url: result.file_url,
                file_type: result.file_type,
                timestamp: new Date().toISOString()
            };
            ws.send(JSON.stringify(message));
            fileInput.value = '';
        }

        // Handle incoming WebSocket messages
        function handleMessage(event) {
            const msg = JSON.parse(event.data);
            if (msg.type === 'text' || msg.type === 'file') {
                displayMessage(msg);
            } else if (msg.type === 'call_signal') {
                handleCallSignal(msg);
            }
        }

        // WebRTC setup
        const servers = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        };

        async function initiateCall(type) {
            if (!currentChatPartner) return;
            currentCallType = type;
            peerConnection = new RTCPeerConnection(servers);

            // Get local stream
            const constraints = type === 'video' ? { video: true, audio: true } : { audio: true };
            localStream = await navigator.mediaDevices.getUserMedia(constraints);
            document.getElementById('local-video').srcObject = localStream;
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            // Handle ICE candidates
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send(JSON.stringify({
                        type: 'call_signal',
                        sender: userID,
                        receiver: currentChatPartner,
                        signal: { type: 'ice-candidate', candidate: event.candidate }
                    }));
                }
            };

            // Handle remote stream
            peerConnection.ontrack = (event) => {
                document.getElementById('remote-video').srcObject = event.streams[0];
                document.getElementById('video-call').style.display = 'flex';
            };

            // Create offer
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            ws.send(JSON.stringify({
                type: 'call_signal',
                sender: userID,
                receiver: currentChatPartner,
                signal: { type: 'call-initiate', offer: offer, call_type: type }
            }));
        }

        async function handleCallSignal(msg) {
            if (!peerConnection) {
                peerConnection = new RTCPeerConnection(servers);
                const constraints = msg.signal.call_type === 'video' ? { video: true, audio: true } : { audio: true };
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                document.getElementById('local-video').srcObject = localStream;
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        ws.send(JSON.stringify({
                            type: 'call_signal',
                            sender: userID,
                            receiver: msg.sender,
                            signal: { type: 'ice-candidate', candidate: event.candidate }
                        }));
                    }
                };

                peerConnection.ontrack = (event) => {
                    document.getElementById('remote-video').srcObject = event.streams[0];
                    document.getElementById('video-call').style.display = 'flex';
                };
            }

            if (msg.signal.type === 'call-initiate') {
                currentCallType = msg.signal.call_type;
                if (confirm(`Incoming ${msg.signal.call_type} call from ${msg.sender}. Accept?`)) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(msg.signal.offer));
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    ws.send(JSON.stringify({
                        type: 'call_signal',
                        sender: userID,
                        receiver: msg.sender,
                        signal: { type: 'call-accept', answer: answer, call_status: 'accepted' }
                    }));
                } else {
                    ws.send(JSON.stringify({
                        type: 'call_signal',
                        sender: userID,
                        receiver: msg.sender,
                        signal: { type: 'call-reject', call_status: 'rejected' }
                    }));
                }
            } else if (msg.signal.type === 'call-accept') {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(msg.signal.answer));
            } else if (msg.signal.type === 'ice-candidate') {
                await peerConnection.addIceCandidate(new RTCIceCandidate(msg.signal.candidate));
            } else if (msg.signal.type === 'call-reject') {
                endCall();
            }
        }

        function endCall() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            document.getElementById('local-video').srcObject = null;
            document.getElementById('remote-video').srcObject = null;
            document.getElementById('video-call').style.display = 'none';
        }

        // Initialize
        if (!token) {
            window.location.href = 'login.html'; // Redirect to login if no token
        } else {
            connectWebSocket();
            loadUsers();
        }
    </script>
</body>
</html>
