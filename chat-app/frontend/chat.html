<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #chat-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        #messages {
            border: 1px solid #ccc;
            padding: 10px;
            height: 400px;
            overflow-y: scroll;
            margin-bottom: 20px;
        }
        #messages div {
            margin-bottom: 10px;
        }
        #call-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        #call-modal-content {
            background: white;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="chat-container">
        <h1 class="text-2xl font-bold mb-4">Chat App</h1>
        <div id="chat-interface">
            <h2 id="chat-partner-name" class="text-lg font-semibold mb-2"></h2>
            <div id="messages"></div>
            <div class="flex mb-2">
                <input type="text" id="message-input" class="flex-grow border rounded-l px-4 py-2 focus:outline-none" placeholder="Type a message...">
                <button id="send-message" class="bg-blue-500 text-white px-4 py-2 rounded-r hover:bg-blue-600">Send</button>
            </div>
            <div class="flex space-x-2">
                <button id="attach-file" class="bg-gray-300 text-black px-4 py-2 rounded hover:bg-gray-400">ðŸ“Ž Attach File</button>
                <input type="file" id="file-input" class="hidden">
                <button id="start-video-call" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">ðŸ“¹ Video Call</button>
                <button id="start-audio-call" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">ðŸ“ž Audio Call</button>
            </div>
        </div>
    </div>

    <div id="call-modal">
        <div id="call-modal-content">
            <p id="call-message"></p>
            <video id="local-video" autoplay playsinline muted class="w-32 h-32"></video>
            <video id="remote-video" autoplay playsinline class="w-64 h-64"></video>
            <div class="mt-4">
                <button id="accept-call" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 mr-2">Accept</button>
                <button id="reject-call" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Reject</button>
                <button id="end-call" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 hidden">End Call</button>
            </div>
        </div>
    </div>

    <script>
        const chatPartnerName = document.getElementById('chat-partner-name');
        const chatInterface = document.getElementById('chat-interface');
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendMessageButton = document.getElementById('send-message');
        const attachFileButton = document.getElementById('attach-file');
        const fileInput = document.getElementById('file-input');
        const startVideoCallButton = document.getElementById('start-video-call');
        const startAudioCallButton = document.getElementById('start-audio-call');
        const callModal = document.getElementById('call-modal');
        const callMessage = document.getElementById('call-message');
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');
        const acceptCallButton = document.getElementById('accept-call');
        const rejectCallButton = document.getElementById('reject-call');
        const endCallButton = document.getElementById('end-call');

        let ws;
        let peerConnection;
        let currentChatId = '';
        let currentReceiver = '';
        let token = '';
        let username = '';
        let localStream;
        let incomingCall = false;
        let callType = '';

        // Get token and username from localStorage
        token = localStorage.getItem('token');
        if (!token) {
            alert('Please log in first');
            window.location.href = 'login.html';
        }
        username = localStorage.getItem('username');

        // Fetch allowed chat partners and start chat automatically
        async function initializeChat() {
            try {
                const response = await fetch('https://chat-backend-gxh8.onrender.com/allowed-chats', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!response.ok) {
                    throw new Error('Failed to fetch allowed chats');
                }
                const allowedUsers = await response.json();

                if (allowedUsers.length === 0) {
                    alert('No chat partners available. Please contact the admin.');
                    return;
                }

                // Determine the chat partner
                let selectedReceiver;
                if (username === 'admin') {
                    // For admin, default to the first user (or implement a selection logic if needed)
                    selectedReceiver = allowedUsers[0];
                } else {
                    // For non-admins, select the non-admin chat partner (exclude admin)
                    selectedReceiver = allowedUsers.find(user => user !== 'admin') || 'admin';
                }

                currentReceiver = selectedReceiver;
                currentChatId = `${username}:${currentReceiver}`;
                chatPartnerName.textContent = `Chatting with: ${currentReceiver}`;
                chatInterface.classList.remove('hidden');
                messagesDiv.innerHTML = '';
                fetchMessages();
                connectWebSocket();
            } catch (err) {
                console.error('Error initializing chat:', err);
                alert('Failed to load chat. Please try again.');
            }
        }

        // Initialize the chat automatically on page load
        initializeChat();

        async function fetchMessages() {
            try {
                const response = await fetch(`https://chat-backend-gxh8.onrender.com/messages?chat_id=${currentChatId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!response.ok) {
                    throw new Error('Failed to fetch messages');
                }
                const messages = await response.json();
                messages.forEach(displayMessage);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            } catch (err) {
                console.error('Error fetching messages:', err);
            }
        }

        function displayMessage(message) {
            const div = document.createElement('div');
            div.className = message.sender === username ? 'text-right text-blue-600' : 'text-left text-green-600';
            
            if (message.type === 'text') {
                div.textContent = `${message.sender}: ${message.content}`;
            } else if (message.type === 'file') {
                if (message.file_type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = message.file_url;
                    img.className = 'max-w-xs my-2';
                    img.onerror = () => img.src = 'https://via.placeholder.com/150?text=Image+Not+Found';
                    div.textContent = `${message.sender}: `;
                    div.appendChild(img);
                } else {
                    const a = document.createElement('a');
                    a.href = message.file_url;
                    a.textContent = 'Download File';
                    a.className = 'text-blue-500 underline';
                    div.textContent = `${message.sender}: `;
                    div.appendChild(a);
                }
            }
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function connectWebSocket() {
            ws = new WebSocket(`wss://chat-backend-gxh8.onrender.com/ws?username=${username}&token=${token}`);
            ws.onopen = () => console.log('WebSocket connected');
            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                if (message.type === 'call_signal' && message.signal.type === 'call-initiate') {
                    incomingCall = true;
                    callType = message.signal.call_type;
                    callMessage.textContent = `Incoming ${callType} call from ${message.sender}`;
                    callModal.style.display = 'flex';
                    acceptCallButton.classList.remove('hidden');
                    rejectCallButton.classList.remove('hidden');
                    endCallButton.classList.add('hidden');
                } else {
                    displayMessage(message);
                }
            };
            ws.onclose = () => console.log('WebSocket disconnected');
        }

        sendMessageButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        function sendMessage() {
            const content = messageInput.value.trim();
            if (!content || !currentReceiver) return;
            const message = {
                type: 'text',
                sender: username,
                receiver: currentReceiver,
                content: content,
                timestamp: new Date().toISOString(),
                status: 'persistent'
            };
            ws.send(JSON.stringify(message));
            messageInput.value = '';
        }

        attachFileButton.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', async () => {
            const file = fileInput.files[0];
            if (!file || !currentReceiver) return;

            const formData = new FormData();
            formData.append('file', file);
            const response = await fetch('https://chat-backend-gxh8.onrender.com/upload', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            });
            const { file_url } = await response.json();
            const message = {
                type: 'file',
                sender: username,
                receiver: currentReceiver,
                file_url: file_url,
                file_type: file.type,
                timestamp: new Date().toISOString(),
                status: 'persistent'
            };
            ws.send(JSON.stringify(message));
            fileInput.value = '';
        });

        startVideoCallButton.addEventListener('click', () => initiateCall('video'));
        startAudioCallButton.addEventListener('click', () => initiateCall('audio'));

        async function initiateCall(type) {
            callType = type;
            callMessage.textContent = `Calling ${currentReceiver}... (${callType})`;
            callModal.style.display = 'flex';
            acceptCallButton.classList.add('hidden');
            rejectCallButton.classList.add('hidden');
            endCallButton.classList.remove('hidden');

            localStream = await navigator.mediaDevices.getUserMedia({ video: type === 'video', audio: true });
            localVideo.srcObject = localStream;

            peerConnection = new RTCPeerConnection();
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            peerConnection.ontrack = (event) => {
                remoteVideo.srcObject = event.streams[0];
            };

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send(JSON.stringify({
                        type: 'call_signal',
                        sender: username,
                        receiver: currentReceiver,
                        signal: { type: 'ice-candidate', candidate: event.candidate }
                    }));
                }
            };

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            ws.send(JSON.stringify({
                type: 'call_signal',
                sender: username,
                receiver: currentReceiver,
                signal: { type: 'call-initiate', offer: offer, call_type: callType }
            }));
        }

        acceptCallButton.addEventListener('click', async () => {
            incomingCall = false;
            callMessage.textContent = `In ${callType} call with ${currentReceiver}`;
            acceptCallButton.classList.add('hidden');
            rejectCallButton.classList.add('hidden');
            endCallButton.classList.remove('hidden');

            localStream = await navigator.mediaDevices.getUserMedia({ video: callType === 'video', audio: true });
            localVideo.srcObject = localStream;

            peerConnection = new RTCPeerConnection();
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            peerConnection.ontrack = (event) => {
                remoteVideo.srcObject = event.streams[0];
            };

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send(JSON.stringify({
                        type: 'call_signal',
                        sender: username,
                        receiver: currentReceiver,
                        signal: { type: 'ice-candidate', candidate: event.candidate }
                    }));
                }
            };

            const offer = JSON.parse(localStorage.getItem('pending-offer'));
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            ws.send(JSON.stringify({
                type: 'call_signal',
                sender: username,
                receiver: currentReceiver,
                signal: { type: 'call-accept', answer: answer, call_status: 'accepted' }
            }));
        });

        rejectCallButton.addEventListener('click', () => {
            incomingCall = false;
            callModal.style.display = 'none';
            ws.send(JSON.stringify({
                type: 'call_signal',
                sender: username,
                receiver: currentReceiver,
                signal: { type: 'call-reject', call_status: 'rejected' }
            }));
        });

        endCallButton.addEventListener('click', () => {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
            callModal.style.display = 'none';
        });

        // Function to convert base64url to Uint8Array
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/-/g, '+')
                .replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // Request notification permission
        if ('Notification' in window) {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    navigator.serviceWorker.register('service-worker.js').then(registration => {
                        const vapidPublicKey = 'BJPmu7lxFqlwyEnBJPfSYdfpqDi_A4EoOmt4fSYqvmjY8IIo44D6vbKQkZGTfx9rcCfxZ4ykHHSacmlo-GkhBeY'; // Replace with your actual VAPID public key from Firebase
                        const convertedVapidKey = urlBase64ToUint8Array(vapidPublicKey);
                        registration.pushManager.subscribe({
                            userVisibleOnly: true,
                            applicationServerKey: convertedVapidKey
                        }).then(subscription => {
                            fetch('https://chat-backend-gxh8.onrender.com/register-push', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({
                                    username: username,
                                    token: JSON.stringify(subscription)
                                })
                            }).catch(err => {
                                console.error('Error registering push subscription:', err);
                            });
                        }).catch(err => {
                            console.error('Error subscribing to push notifications:', err);
                        });
                    }).catch(err => {
                        console.error('Error registering service worker:', err);
                    });
                }
            }).catch(err => {
                console.error('Error requesting notification permission:', err);
            });
        }
    </script>
</body>
</html>
